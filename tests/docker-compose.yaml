version: '2'

services:
    crossdock:
        image: crossdock/crossdock:eea24ac3
        links:
            - refnode
            - refnode1
            - example1

        environment:
            - WAIT_FOR_TIMEOUT=2s
            - CALL_TIMEOUT=2s

            # For real tests add actual tracer implementations here, e.g. example1.
            - WAIT_FOR=refnode,refnode1,example1

            # First axis of every behavior is the name of the driver node (this should never change).
            - AXIS_DRIVER=refnode

            # For real tests add actual tracer implementations here, e.g. example1.
            - AXIS_ACTOR=refnode,refnode1,example1

            # Behaviors are executed in alphabetical order, so keep them sorted here too.
            - BEHAVIOR_MALFORMED_TRACE_CONTEXT=driver,actor
            - BEHAVIOR_MISSING_TRACE_CONTEXT=driver,actor
            - BEHAVIOR_TRACE_CONTEXT_DIFF_VENDOR=driver,actor
            - BEHAVIOR_TRACE_CONTEXT_SAME_VENDOR=driver,actor

    # refnode acts as the test driver ("client" for crossdock) as well as reference implementation of test node.
    refnode:
        build: .
        ports:
            - "8080-8081"
        environment:
            - ACTOR_NAME=refnode
            - TRUST_TRACE_ID=true
            - TRUST_SAMPLING=true
            - SAMPLE=true
            - UPSAMPLE=false

    # refnode1 does not trust incoming trace IDs
    refnode1:
        build: .
        ports:
            - "8080-8081"
        environment:
            - ACTOR_NAME=refnode1
            - TRUST_TRACE_ID=false
            - TRUST_SAMPLING=true
            - SAMPLE=true
            - UPSAMPLE=false

    # example1 shows how to use vendor-implemented actor
    example1:
        build: ./example/
        ports:
            - "8080-8081"
        environment:
            - ACTOR_NAME=example1
            - TRUST_TRACE_ID=true
            - TRUST_SAMPLING=true
            - SAMPLE=true
            - UPSAMPLE=false
